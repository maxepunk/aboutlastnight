#!/bin/bash
# HTML Validation Git Hook
# Version: 1.0.0
# Validates HTML structure before allowing commits

# Get list of staged HTML files
HTML_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '\.html$')

# If no HTML files staged, exit success
if [ -z "$HTML_FILES" ]; then
    exit 0
fi

# Check if tidy is installed
if ! command -v tidy &> /dev/null; then
    echo "⚠️  WARNING: tidy not installed, skipping HTML validation"
    echo "   Install with: sudo apt-get install tidy"
    exit 0  # Don't block commit if tool unavailable
fi

# Print validation header
echo "🔍 Validating HTML files..."

ERRORS=0
for file in $HTML_FILES; do
    # Run tidy validation
    # -q: quiet mode (no summary)
    # -e: show only errors
    # --gnu-emacs yes: GNU Emacs-compatible format (file:line:col:)
    # Exit codes: 0=no issues, 1=warnings only, 2=errors
    OUTPUT=$(tidy -q -e --gnu-emacs yes "$file" 2>&1)
    EXIT_CODE=$?

    if [ $EXIT_CODE -eq 2 ]; then
        # Errors found - block commit
        echo "❌ ERROR: $file has validation errors"
        echo "$OUTPUT"
        ERRORS=1
    elif [ $EXIT_CODE -eq 1 ]; then
        # Warnings only - allow commit but notify
        echo "⚠️  $file has warnings (allowing commit)"
    else
        # No issues
        echo "✓ $file"
    fi
done

if [ $ERRORS -eq 1 ]; then
    echo ""
    echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    echo "HTML validation failed with errors."
    echo ""
    echo "Please fix the errors listed above before committing."
    echo ""
    echo "To skip validation (not recommended):"
    echo "  git commit --no-verify"
    echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    exit 1
fi

# Run quick tests (if installed)
if [ -d "tests/node_modules" ]; then
    echo ""
    echo "🧪 Running quick tests..."
    cd tests
    npm run test:quick --silent
    TEST_EXIT_CODE=$?
    cd ..

    if [ $TEST_EXIT_CODE -ne 0 ]; then
        echo ""
        echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
        echo "Quick tests failed."
        echo ""
        echo "Please fix the test failures before committing."
        echo ""
        echo "To skip tests (not recommended):"
        echo "  git commit --no-verify"
        echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
        exit 1
    fi
else
    echo ""
    echo "⚠️  Tests not installed. Run: cd tests && npm install"
    echo "   Skipping quick tests for this commit..."
fi

exit 0
